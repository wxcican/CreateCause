package com.mzth.createcause.view.fragment.news.impl;import android.app.Dialog;import android.content.Intent;import android.support.v4.widget.SwipeRefreshLayout;import android.support.v7.widget.LinearLayoutManager;import android.support.v7.widget.RecyclerView;import android.util.Log;import android.view.View;import android.widget.ImageView;import android.widget.LinearLayout;import android.widget.TextView;import android.widget.Toast;import com.chad.library.adapter.base.BaseQuickAdapter;import com.mzth.createcause.R;import com.mzth.createcause.adapter.news.MoreCommentAdapter;import com.mzth.createcause.adapter.news.ReleaseCommentActivity;import com.mzth.createcause.base.BaseActivity;import com.mzth.createcause.entity.core.AnalyCommentInfoEntity;import com.mzth.createcause.entity.core.NewsInfoEntity;import com.mzth.createcause.presenter.core.MoreCommentPresenter;import com.mzth.createcause.util.CommonUtil;import com.mzth.createcause.util.ConfigUtil;import com.mzth.createcause.util.RetentionDataUtil;import com.mzth.createcause.view.fragment.CommentFunction;import com.mzth.createcause.view.fragment.news.IMoreCommentActivity;import com.umeng.socialize.UMShareAPI;import com.umeng.socialize.UMShareListener;import com.umeng.socialize.bean.SHARE_MEDIA;import java.util.ArrayList;import java.util.List;/** * 更多评论 */public class MoreCommentActivity extends BaseActivity implements IMoreCommentActivity {    private TextView base_title;    private ImageView base_iv;    private TextView base_tv;    private RecyclerView rv_news_info_more;    private SwipeRefreshLayout srl_news_info_more;    private LinearLayout ll_more_back;    private LinearLayout ll_more_share;    private TextView tv_more_comment;    private String news_id;    private List<NewsInfoEntity> mNewsInfoEntiyts = new ArrayList<>();    private MoreCommentPresenter mMoreCommentPresenter;    private MoreCommentAdapter mMoreCommentAdapter;    private Dialog dialog;    public static String comment_tyupe;    private String info_title;    private String info_content;    private String info_img;    @Override    protected void setActivity() {        setContentView(R.layout.activity_more_comment);        mMoreCommentPresenter = new MoreCommentPresenter();        mMoreCommentPresenter.initIMoreCommentActivity(this);    }    @Override    protected void initView() {        base_title = CommonUtil.getCommonUtil().bindView(this, R.id.base_title);        base_iv = CommonUtil.getCommonUtil().bindView(this, R.id.base_iv);        base_tv = CommonUtil.getCommonUtil().bindView(this, R.id.base_tv);        rv_news_info_more = CommonUtil.getCommonUtil().bindView(this, R.id.rv_news_info_more);        ll_more_back = CommonUtil.getCommonUtil().bindView(this, R.id.ll_more_back);        tv_more_comment = CommonUtil.getCommonUtil().bindView(this, R.id.tv_more_comment);        srl_news_info_more = CommonUtil.getCommonUtil().bindView(this, R.id.srl_news_info_more);        ll_more_share = CommonUtil.getCommonUtil().bindView(this, R.id.ll_more_share);    }    @Override    protected void initSet() {        Intent mIntent=getIntent();        news_id = mIntent.getStringExtra("IINFO_ID");        info_title = mIntent.getStringExtra("INFO_TITLE");        info_content = mIntent.getStringExtra("INFO_CONTENT");        info_img = mIntent.getStringExtra("INFO_IMG");        base_iv.setVisibility(View.GONE);        base_tv.setVisibility(View.GONE);        base_title.setText("评论");    }    @Override    protected void initAdapter() {        mMoreCommentAdapter = new MoreCommentAdapter(mNewsInfoEntiyts);        rv_news_info_more.setLayoutManager(new LinearLayoutManager(mContext, LinearLayoutManager.VERTICAL, false));        rv_news_info_more.setAdapter(mMoreCommentAdapter);        mMoreCommentAdapter.setEmptyView(mNoDataView);    }    private int page = 0;    private List<NewsInfoEntity> cacheData=new ArrayList<>();    @Override    protected void initData() {        cacheData.clear();        mMoreCommentPresenter.initMoreCommentData(news_id, page, cacheData, true);    }    @Override    protected void initListener() {        //刷新        srl_news_info_more.setOnRefreshListener(new SwipeRefreshLayout.OnRefreshListener() {            @Override            public void onRefresh() {                page = 0;                cacheData.clear();                mMoreCommentPresenter.initMoreCommentData(news_id, page, cacheData, false);            }        });        //加载        mMoreCommentAdapter.setOnLoadMoreListener(new BaseQuickAdapter.RequestLoadMoreListener() {            @Override            public void onLoadMoreRequested() {                page++;                mMoreCommentPresenter.initMoreCommentData(news_id, page, cacheData, false);            }        }, rv_news_info_more);        //返回原文        ll_more_back.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View v) {                finish();            }        });        //评论        tv_more_comment.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View v) {                CommentFunction.getCommentFunction().actionComment(MoreCommentActivity.this,news_id);            }        });        //点赞        mMoreCommentAdapter.setOnMoreGoodClickListener(new MoreCommentAdapter.OnMoreGoodClickListener() {            @Override            public void onGoodClick(String commentID, final String type, final int position) {                CommentFunction.getCommentFunction().actionGood(news_id, commentID, userId, type);                CommentFunction.getCommentFunction().setOnGoodSuccessListener(new CommentFunction.OnGoodSuccessListener() {                    @Override                    public void onSuccess() {                        //点赞需要刷新数据                        RetentionDataUtil.getRetention().setBoolean("INFO_TAG",true);                        mMoreCommentAdapter.modifyData(type.endsWith("1"), position);                    }                });            }        });        //回复        mMoreCommentAdapter.setOnMoreCommentClickListener(new MoreCommentAdapter.OnMoreCommentClickListener() {            @Override            public void onReplyClick(String commentID, String toUserId, String toUserName) {                CommentFunction.getCommentFunction().actionReply(MoreCommentActivity.this, commentID, toUserId, toUserName);            }        });        //分享        ll_more_share.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View v) {                CommentFunction.getCommentFunction().actionShare(MoreCommentActivity.this,                        news_id,                        info_title,                        info_content,                        info_img,                        shareListener                        );            }        });    }    @Override    public void onRequestStart() {        dialog = CommonUtil.getCommonUtil().ejectLaoding(mContext, "正在加载");    }    @Override    public void onRequestFinish() {        if (dialog != null && dialog.isShowing()) {            dialog.dismiss();            dialog = null;        }    }    @Override    public void onRequestError() {        CommonUtil.getCommonUtil().toast(ConfigUtil.HINT_OVERTIME);    }    @Override    public void onToast(String content) {        CommonUtil.getCommonUtil().toast(content);    }    @Override    public void commentInfoData(AnalyCommentInfoEntity mAnalyCommentInfoEntity) {        mNewsInfoEntiyts.clear();        mNewsInfoEntiyts.addAll(cacheData);        mMoreCommentAdapter.notifyDataSetChanged();        if (mAnalyCommentInfoEntity.getPage()+1 < mAnalyCommentInfoEntity.getPage_total()) {            mMoreCommentAdapter.loadMoreComplete();        }else {            mMoreCommentAdapter.loadMoreEnd();        }        if (srl_news_info_more.isRefreshing()) {            srl_news_info_more.setRefreshing(false);        }    }    @Override    protected void onResume() {        super.onResume();        if (RetentionDataUtil.getRetention().getBoolean("MORE_TAG",false)) {            RetentionDataUtil.getRetention().setBoolean("MORE_TAG",false);            cacheData.clear();            mMoreCommentPresenter.initMoreCommentData(news_id, 0, cacheData, true);        }    }    @Override    protected void onActivityResult(int requestCode, int resultCode, Intent data) {        super.onActivityResult(requestCode, resultCode, data);        UMShareAPI.get(this).onActivityResult(requestCode, resultCode, data);    }    private UMShareListener shareListener = new UMShareListener() {        /**         * @descrption 分享开始的回调         * @param platform 平台类型         */        @Override        public void onStart(SHARE_MEDIA platform) {        }        /**         * @descrption 分享成功的回调         * @param platform 平台类型         */        @Override        public void onResult(SHARE_MEDIA platform) {            CommentFunction.getCommentFunction().shareEnd(userId,news_id);        }        /**         * @descrption 分享失败的回调         * @param platform 平台类型         * @param t 错误原因         */        @Override        public void onError(SHARE_MEDIA platform, Throwable t) {        }        /**         * @descrption 分享取消的回调         * @param platform 平台类型         */        @Override        public void onCancel(SHARE_MEDIA platform) {        }    };}