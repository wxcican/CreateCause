package com.mzth.createcause.view.fragment.home;import android.app.Dialog;import android.content.Intent;import android.content.pm.PackageInfo;import android.content.pm.PackageManager;import android.graphics.Color;import android.net.Uri;import android.support.annotation.Nullable;import android.support.v4.widget.SwipeRefreshLayout;import android.support.v7.app.AppCompatActivity;import android.os.Bundle;import android.support.v7.widget.GridLayoutManager;import android.support.v7.widget.RecyclerView;import android.text.TextPaint;import android.text.TextUtils;import android.util.Log;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.EditText;import android.widget.TextView;import android.widget.Toast;import com.chad.library.adapter.base.BaseQuickAdapter;import com.luck.picture.lib.decoration.GridSpacingItemDecoration;import com.mzth.createcause.R;import com.mzth.createcause.adapter.home.HomeAdapter;import com.mzth.createcause.base.BaseFragment;import com.mzth.createcause.entity.home.HomeEntity;import com.mzth.createcause.presenter.home.HomePressenter;import com.mzth.createcause.util.CommonUtil;import com.mzth.createcause.util.ConfigUtil;import com.mzth.createcause.util.DividerItemDecoration;import java.util.ArrayList;import java.util.List;public class HomeFragment extends BaseFragment implements IHomeFragment {    //界面    private View view;    //title    private TextView tv_home_title;    //内容    private RecyclerView rv_home;    //搜索    private TextView tv_home_search;    //搜索框    private EditText et_home;    private SwipeRefreshLayout srl_home;    private final String BAIDU = "https://www.baidu.com/s?wd=";    private HomePressenter homePressenter;    private Dialog dialog;    private List<HomeEntity.HomeContents> mHomeContents = new ArrayList<>();    private HomeAdapter mHomeAdapter;    @Override    protected void initView() {        tv_home_title = CommonUtil.getCommonUtil().bindView(view, R.id.tv_home_title);        rv_home = CommonUtil.getCommonUtil().bindView(view, R.id.rv_home);        tv_home_search = CommonUtil.getCommonUtil().bindView(view, R.id.tv_home_search);        et_home = CommonUtil.getCommonUtil().bindView(view, R.id.et_home);        srl_home = CommonUtil.getCommonUtil().bindView(view, R.id.srl_home);    }    @Override    protected void initSet() {        TextPaint mPaint = tv_home_title.getPaint();        mPaint.setFakeBoldText(true);    }    @Override    protected void initAdapter() {    }    @Override    protected void initData() {        homePressenter.initData();    }    @Override    protected void initListner() {        //搜搜        tv_home_search.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View v) {                String searchContent = et_home.getText().toString().trim();                Intent mIntent = new Intent();                mIntent.setAction("android.intent.action.VIEW");                Uri uri = null;                if (TextUtils.isEmpty(searchContent)) {                    String searchHine = et_home.getHint().toString().trim();                    uri = Uri.parse(BAIDU + searchHine);                } else {                    uri = Uri.parse(BAIDU + searchContent);                }                mIntent.setData(uri);                startActivity(mIntent);            }        });        //刷新        srl_home.setOnRefreshListener(new SwipeRefreshLayout.OnRefreshListener() {            @Override            public void onRefresh() {                homePressenter.refreshData();            }        });    }    @Override    protected View createView(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {        view = inflater.inflate(R.layout.activity_home_fragment, container, false);        homePressenter = HomePressenter.getHomePressenter();        homePressenter.initHomeInterface(this);        return view;    }    @Override    public void initAdapter(HomeEntity homeEntity) {        et_home.setHint(homeEntity.getTitle());        mHomeContents.addAll(homeEntity.getmHomeContentss());        mHomeAdapter = new HomeAdapter(mHomeContents);        GridLayoutManager mGridLayoutManager = new GridLayoutManager(getActivity(), 4);        rv_home.addItemDecoration(new GridSpacingItemDecoration(4, CommonUtil.getCommonUtil().convertDIP(1), true));        rv_home.setLayoutManager(mGridLayoutManager);        rv_home.setAdapter(mHomeAdapter);        //加载        mHomeAdapter.setOnLoadMoreListener(new BaseQuickAdapter.RequestLoadMoreListener() {            @Override            public void onLoadMoreRequested() {                page++;                homePressenter.loadData(page);            }        }, rv_home);        //item点击事件        mHomeAdapter.setOnItemClickListener(new BaseQuickAdapter.OnItemClickListener() {            @Override            public void onItemClick(BaseQuickAdapter adapter, View view, int position) {                String pageNeame = mHomeContents.get(position).getApp_name();                if (checkPackInfo(pageNeame)) {                    PackageManager packageManager = getActivity().getPackageManager();                    if(packageManager!=null){                        Intent intent = packageManager.getLaunchIntentForPackage(pageNeame);                        if(intent!=null){                            startActivity(intent);                        }                    }                } else {                    String url = mHomeContents.get(position).getUrl();                    Log.i(TAG, "onItemClick: "+url);                    if (!TextUtils.isEmpty(url)) {                        if (url.indexOf("http") != -1) {                            Intent mIntent = new Intent();                            mIntent.setAction("android.intent.action.VIEW");                            Uri uri = Uri.parse(url);                            mIntent.setData(uri);                            startActivity(mIntent);                        }                    }                }            }        });        judgePage(page, homeEntity);    }    @Override    public void initRefResh(HomeEntity homeEntity) {        if (srl_home.isRefreshing()) {            srl_home.setRefreshing(false);        }        mHomeContents.clear();        mHomeContents.addAll(homeEntity.getmHomeContentss());        mHomeAdapter.notifyDataSetChanged();        page = 0;        judgePage(page, homeEntity);    }    @Override    public void loadData(HomeEntity homeEntity) {        mHomeContents.addAll(homeEntity.getmHomeContentss());        mHomeAdapter.notifyDataSetChanged();        judgePage(page, homeEntity);    }    @Override    public void ejectLoad(boolean isEject) {        if (isEject) {            dialog = CommonUtil.getCommonUtil().ejectLaoding(mContext, "正在加载");        } else {            if (dialog != null && dialog.isShowing()) {                dialog.dismiss();            }        }    }    private int page = 0;    private void judgePage(int page, HomeEntity homeEntity) {        if ((page + 1) < homeEntity.getPage_total()) {            mHomeAdapter.loadMoreComplete();        } else {            mHomeAdapter.loadMoreEnd();        }    }    private boolean checkPackInfo(String packname) {        PackageInfo packageInfo = null;        try {            packageInfo = getActivity().getPackageManager().getPackageInfo(packname, 0);        } catch (PackageManager.NameNotFoundException e) {            e.printStackTrace();        }        return packageInfo != null;    }    @Override    public void onRequestStart() {    }    @Override    public void onRequestFinish() {    }    @Override    public void onRequestError() {        Toast.makeText(mContext, ConfigUtil.HINT_OVERTIME, Toast.LENGTH_SHORT).show();    }    @Override    public void onToast(String content) {    }}