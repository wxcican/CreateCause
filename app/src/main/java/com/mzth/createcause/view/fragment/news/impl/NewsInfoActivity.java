package com.mzth.createcause.view.fragment.news.impl;import android.app.Dialog;import android.content.Intent;import android.support.v7.widget.LinearLayoutManager;import android.support.v7.widget.RecyclerView;import android.text.TextUtils;import android.util.Log;import android.view.View;import android.widget.ImageView;import android.widget.LinearLayout;import android.widget.RelativeLayout;import android.widget.TextView;import android.widget.Toast;import com.lzy.okgo.OkGo;import com.lzy.okgo.callback.StringCallback;import com.lzy.okgo.model.Response;import com.lzy.okgo.request.base.Request;import com.mzth.createcause.R;import com.mzth.createcause.adapter.news.NewsInfoAdapter;import com.mzth.createcause.adapter.news.ReleaseCommentActivity;import com.mzth.createcause.base.BaseActivity;import com.mzth.createcause.entity.core.NewsInfoEntity;import com.mzth.createcause.presenter.core.NewsInfoPresenter;import com.mzth.createcause.util.CommonUtil;import com.mzth.createcause.util.ConfigUtil;import com.mzth.createcause.util.RetentionDataUtil;import com.mzth.createcause.view.fragment.CommentFunction;import com.mzth.createcause.view.fragment.news.INewsInfoActivity;import com.mzth.createcause.view.login.LoginActivity;import com.umeng.socialize.ShareAction;import com.umeng.socialize.UMShareAPI;import com.umeng.socialize.UMShareListener;import com.umeng.socialize.bean.SHARE_MEDIA;import com.umeng.socialize.media.UMImage;import com.umeng.socialize.media.UMVideo;import com.umeng.socialize.media.UMWeb;import org.json.JSONException;import org.json.JSONObject;import java.security.MessageDigest;import java.security.NoSuchAlgorithmException;import java.util.ArrayList;import java.util.List;/** * 资讯详情 */public class NewsInfoActivity extends BaseActivity implements INewsInfoActivity {    private TextView base_title;    private ImageView base_iv;    private TextView base_tv,base_tv_publish;    private RecyclerView rv_news_info;    private List<NewsInfoEntity> mNewsInfoEntities = new ArrayList<>();    //回到顶部    private ImageView iv_news_info_top;    private ScrollerListener mScrollerListener;    private NewsInfoPresenter mNewsInfoPresenter;    private NewsInfoAdapter mNewsInfoAdapter;    private Dialog dialog;    private String news_id;    private String news_title;    private String news_content;    private String news_img;    @Override    protected void setActivity() {        setContentView(R.layout.activity_news_info);        mNewsInfoPresenter = new NewsInfoPresenter();        mNewsInfoPresenter.initINewsInfoActivity(this);    }    @Override    protected void initView() {        base_title = CommonUtil.getCommonUtil().bindView(this, R.id.base_title);        base_iv = CommonUtil.getCommonUtil().bindView(this, R.id.base_iv);        base_tv = CommonUtil.getCommonUtil().bindView(this, R.id.base_tv);        base_tv_publish = CommonUtil.getCommonUtil().bindView(this, R.id.base_tv_publish);        rv_news_info = CommonUtil.getCommonUtil().bindView(this, R.id.rv_news_info);        iv_news_info_top = CommonUtil.getCommonUtil().bindView(this, R.id.iv_news_info_top);    }    @Override    protected void initSet() {        base_iv.setVisibility(View.GONE);        base_tv.setVisibility(View.GONE);        base_tv_publish.setVisibility(View.GONE);        base_title.setText("资讯详情");    }    @Override    protected void initAdapter() {        mNewsInfoAdapter = new NewsInfoAdapter(mNewsInfoEntities);        rv_news_info.setLayoutManager(new LinearLayoutManager(mContext, LinearLayoutManager.VERTICAL, false));        rv_news_info.setAdapter(mNewsInfoAdapter);    }    @Override    protected void initData() {        Intent mIntent = getIntent();        news_id = mIntent.getStringExtra("NEWS_ID");        news_title = mIntent.getStringExtra("NEWS_TITLE");        news_content = mIntent.getStringExtra("NEWS_CONTENT");        news_img = mIntent.getStringExtra("NEWS_IMG");        if (TextUtils.isEmpty(news_id)) {        } else {            mNewsInfoPresenter.queryData(news_id);        }    }    @Override    protected void initListener() {        //回到顶部        iv_news_info_top.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View v) {                rv_news_info.scrollToPosition(0);            }        });        //发表评论        mNewsInfoAdapter.setOnCommentClickListener(new NewsInfoAdapter.OnCommentClickListener() {            @Override            public void onCommentClick() {                CommentFunction.getCommentFunction().actionComment(NewsInfoActivity.this, news_id);            }        });        //回复评论        mNewsInfoAdapter.setOnReplyClickListener(new NewsInfoAdapter.OnReplyClickListener() {            @Override            public void onReplyClick(String commentID, String toUserId, String toUserName) {                CommentFunction.getCommentFunction().actionReply(NewsInfoActivity.this, commentID, toUserId, toUserName);            }        });        //推荐        mNewsInfoAdapter.setOnRecommendClickListener(new NewsInfoAdapter.OnRecommendClickListener() {            @Override            public void onRecommendClick(String newID) {                Intent mIntent = new Intent();                mIntent.setClass(mContext, NewsInfoActivity.class);                mIntent.putExtra("NEWS_ID", newID);                startActivity(mIntent);                finish();            }        });        //点赞        mNewsInfoAdapter.setOnGoodClickListener(new NewsInfoAdapter.OnGoodClickListener() {            @Override            public void onGoodClick(String commentID, final String type, final int position) {                CommentFunction.getCommentFunction().actionGood(news_id, commentID, userId, type);                CommentFunction.getCommentFunction().setOnGoodSuccessListener(new CommentFunction.OnGoodSuccessListener() {                    @Override                    public void onSuccess() {                        Log.i(TAG, "资讯点赞回调: ");                        mNewsInfoAdapter.modifyData(type.endsWith("1"), position);                    }                });            }        });        //查看更多评论        mNewsInfoAdapter.setOnMoreCOmmentClickListener(new NewsInfoAdapter.OnMoreCOmmentClickListener() {            @Override            public void onMoreCOmmentClick() {                if (mNewsInfoPresenter != null && news_id != null) {                    page++;                    mNewsInfoPresenter.queryCommentData(news_id, page, mNewsInfoEntities);                }            }        });        //更多评论        mNewsInfoAdapter.setOnMoreClickListener(new NewsInfoAdapter.OnMoreClickListener() {            @Override            public void onMoreClick() {                MoreCommentActivity.comment_tyupe = "NEWS";                CommentFunction.getCommentFunction().actionMore(NewsInfoActivity.this, news_id,news_title,news_content,news_img);            }        });        //分享        mNewsInfoAdapter.setOnShareClickListener(new NewsInfoAdapter.OnShareClickListener() {            @Override            public void onShareClick() {                CommentFunction.getCommentFunction().actionShare(NewsInfoActivity.this,                        news_id,                        news_title,                        news_content,                        news_img,                        shareListener                );            }        });        //发布者详情        mNewsInfoAdapter.setOnAuthorInfoClickListener(new NewsInfoAdapter.OnAuthorInfoClickListener() {            @Override            public void onAuthorInfoClick(String authorId) {               CommentFunction.getCommentFunction().actionAuthorInfo(NewsInfoActivity.this,authorId);            }        });    }    private int page = 0;    @Override    public void onRequestStart() {        dialog = CommonUtil.getCommonUtil().ejectLaoding(mContext, "正在加载");    }    @Override    public void onRequestFinish() {        if (dialog != null && dialog.isShowing()) {            dialog.dismiss();        }    }    @Override    public void onRequestError() {        CommonUtil.getCommonUtil().toast(ConfigUtil.HINT_OVERTIME);    }    @Override    public void onToast(String content) {        CommonUtil.getCommonUtil().toast(content);    }    @Override    public void initNewsInfoData(List<NewsInfoEntity> newsInfoEntitys) {        mNewsInfoEntities.clear();        mNewsInfoEntities.addAll(newsInfoEntitys);        mNewsInfoAdapter.notifyDataSetChanged();    }    @Override    public void initNewsInfoCommentData(List<NewsInfoEntity> mNewsInfoCommnetEntities) {        mNewsInfoAdapter.notifyDataSetChanged();    }    /**     * 内容滑动监听     */    private class ScrollerListener extends RecyclerView.OnScrollListener {        @Override        public void onScrolled(RecyclerView recyclerView, int dx, int dy) {            super.onScrolled(recyclerView, dx, dy);            RecyclerView.LayoutManager layoutManager = recyclerView.getLayoutManager();            if (layoutManager instanceof LinearLayoutManager) {                //最后一个可见的item                int lastVisibleItemPosition = ((LinearLayoutManager) layoutManager).findLastVisibleItemPosition();                //第一个可见的item                int firstVisibleItemPosition = ((LinearLayoutManager) layoutManager).findFirstVisibleItemPosition();                if (firstVisibleItemPosition > 1) {                    if (iv_news_info_top.getVisibility() == View.INVISIBLE || iv_news_info_top.getVisibility() == View.GONE) {                        iv_news_info_top.setVisibility(View.VISIBLE);                    }                } else {                    if (iv_news_info_top.getVisibility() == View.VISIBLE) {                        iv_news_info_top.setVisibility(View.INVISIBLE);                    }                }            }        }    }    @Override    protected void onResume() {        super.onResume();        if (rv_news_info != null) {            if (mScrollerListener == null) {                mScrollerListener = new ScrollerListener();            }            rv_news_info.addOnScrollListener(mScrollerListener);        }        if (RetentionDataUtil.getRetention().getBoolean("INFO_TAG", false)) {            //返回原有的状态            RetentionDataUtil.getRetention().setBoolean("INFO_TAG", false);            RetentionDataUtil.getRetention().setBoolean("MORE_TAG", false);            if (mNewsInfoPresenter != null && news_id != null) {                mNewsInfoPresenter.queryData(news_id);            }        }    }    @Override    protected void onPause() {        super.onPause();        if (rv_news_info != null) {            if (mScrollerListener != null) {                rv_news_info.removeOnScrollListener(mScrollerListener);            }        }    }    private UMShareListener shareListener = new UMShareListener() {        /**         * @descrption 分享开始的回调         * @param platform 平台类型         */        @Override        public void onStart(SHARE_MEDIA platform) {        }        /**         * @descrption 分享成功的回调         * @param platform 平台类型         */        @Override        public void onResult(SHARE_MEDIA platform) {            CommentFunction.getCommentFunction().shareEnd(userId,news_id);        }        /**         * @descrption 分享失败的回调         * @param platform 平台类型         * @param t 错误原因         */        @Override        public void onError(SHARE_MEDIA platform, Throwable t) {        }        /**         * @descrption 分享取消的回调         * @param platform 平台类型         */        @Override        public void onCancel(SHARE_MEDIA platform) {        }    };    @Override    protected void onActivityResult(int requestCode, int resultCode, Intent data) {        super.onActivityResult(requestCode, resultCode, data);        UMShareAPI.get(this).onActivityResult(requestCode, resultCode, data);    }}