package com.mzth.createcause.view.fragment.user.eaaaymessage;import android.app.Dialog;import android.content.Intent;import android.support.v4.widget.SwipeRefreshLayout;import android.support.v7.widget.LinearLayoutManager;import android.support.v7.widget.RecyclerView;import android.util.Log;import android.view.LayoutInflater;import android.view.View;import android.widget.ImageView;import android.widget.LinearLayout;import android.widget.PopupWindow;import android.widget.RelativeLayout;import android.widget.TextView;import com.chad.library.adapter.base.BaseQuickAdapter;import com.lzy.okgo.OkGo;import com.lzy.okgo.callback.StringCallback;import com.lzy.okgo.model.Response;import com.lzy.okgo.request.base.Request;import com.mzth.createcause.R;import com.mzth.createcause.adapter.user.EssayDraftAdapter;import com.mzth.createcause.base.BaseActivity;import com.mzth.createcause.entity.user.EssayMessageEntity;import com.mzth.createcause.util.CommonUtil;import com.mzth.createcause.util.ConfigUtil;import com.mzth.createcause.util.DividerItemDecoration;import com.mzth.createcause.view.shareui.SearchActivity;import org.json.JSONException;import org.json.JSONObject;import java.util.ArrayList;import java.util.List;/** * 草稿箱 */public class EssayDraftActivity extends BaseActivity {    private TextView base_title;    private ImageView base_iv;    private TextView base_tv;    //搜索    private RelativeLayout base_rl;    //全选    private LinearLayout ll_user_essay_draft;    private ImageView iv_user_essay_draft;    private boolean isAllSelect = false;    //内容    private RecyclerView rv_user_essay_draft;    //删除    private TextView tv_user_essay_draft_1;    //发布    private TextView tv_user_essay_draft_2;    private EssayDraftAdapter mEssayDraftAdapter;    private PopupWindow mPopupWindow;    private Dialog dialog;    private SwipeRefreshLayout srl_user_essay_draft;    private List<com.mzth.createcause.entity.user.EssayMessageEntity.EssayMessageList> mEssayMessageLists = new ArrayList<>();    @Override    protected void setActivity() {        setContentView(R.layout.activity_essay_draft);    }    @Override    protected void initView() {        base_title = CommonUtil.getCommonUtil().bindView(this, R.id.base_title);        base_iv = CommonUtil.getCommonUtil().bindView(this, R.id.base_iv);        base_tv = CommonUtil.getCommonUtil().bindView(this, R.id.base_tv);        ll_user_essay_draft = CommonUtil.getCommonUtil().bindView(this, R.id.ll_user_essay_draft);        iv_user_essay_draft = CommonUtil.getCommonUtil().bindView(this, R.id.iv_user_essay_draft);        rv_user_essay_draft = CommonUtil.getCommonUtil().bindView(this, R.id.rv_user_essay_draft);        tv_user_essay_draft_1 = CommonUtil.getCommonUtil().bindView(this, R.id.tv_user_essay_draft_1);        tv_user_essay_draft_2 = CommonUtil.getCommonUtil().bindView(this, R.id.tv_user_essay_draft_2);        base_rl = CommonUtil.getCommonUtil().bindView(this, R.id.base_rl);        srl_user_essay_draft = CommonUtil.getCommonUtil().bindView(this, R.id.srl_user_essay_draft);    }    @Override    protected void initSet() {        base_title.setText("草稿箱");        base_iv.setVisibility(View.GONE);        base_tv.setVisibility(View.GONE);    }    @Override    protected void initAdapter() {        mEssayDraftAdapter = new EssayDraftAdapter(mEssayMessageLists);        rv_user_essay_draft.setLayoutManager(new LinearLayoutManager(mContext, LinearLayoutManager.VERTICAL, false));        rv_user_essay_draft.addItemDecoration(new DividerItemDecoration(mContext,                LinearLayoutManager.HORIZONTAL,                CommonUtil.getCommonUtil().convertDIP(1),                getResources().getColor(R.color.colorDiv)));        rv_user_essay_draft.setAdapter(mEssayDraftAdapter);        mEssayDraftAdapter.setEmptyView(mNoDataView);    }    @Override    protected void initData() {        initNetData(0, false, false);    }    @Override    protected void initListener() {        //搜索        base_rl.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                Intent mIntent = new Intent();                mIntent.setClass(mContext, SearchActivity.class);                startActivity(mIntent);            }        });        //全选        ll_user_essay_draft.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View v) {                if (iv_user_essay_draft.isSelected()) {                    iv_user_essay_draft.setSelected(false);                    for (int i = 0; i < mEssayMessageLists.size(); i++) {                        mEssayMessageLists.get(i).setSelect(false);                        mEssayDraftAdapter.notifyDataSetChanged();                    }                } else {                    iv_user_essay_draft.setSelected(true);                    for (int i = 0; i < mEssayMessageLists.size(); i++) {                        mEssayMessageLists.get(i).setSelect(true);                        mEssayDraftAdapter.notifyDataSetChanged();                    }                }            }        });        //删除        tv_user_essay_draft_1.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View v) {                StringBuffer mStringBuffer = new StringBuffer();                for (int i = 0; i < mEssayMessageLists.size(); i++) {                    EssayMessageEntity.EssayMessageList essayMessageList = mEssayMessageLists.get(i);                    if (essayMessageList.isSelect()) {                        mStringBuffer.append(essayMessageList.getId() + ",");                    }                }                if (mStringBuffer.length() == 0) {                    CommonUtil.getCommonUtil().toast("请选择文章进行操作");                } else {                    OkGo.<String>post(ConfigUtil.REQUEST_ESSAT_DELETE)                            .params("user_id",userId)                            .params("auth_key",userKey)                            .params("id",mStringBuffer.toString())                            .execute(new StringCallback() {                                @Override                                public void onStart(Request<String, ? extends Request> request) {                                    super.onStart(request);                                     dialog = CommonUtil.getCommonUtil().ejectLaoding(mContext, "正在删除");                                }                                @Override                                public void onError(Response<String> response) {                                    super.onError(response);                                    CommonUtil.getCommonUtil().toast(ConfigUtil.HINT_OVERTIME);                                }                                @Override                                public void onFinish() {                                    super.onFinish();                                    if(dialog!=null&&dialog.isShowing()){                                        dialog.dismiss();                                        dialog=null;                                    }                                }                                @Override                                public void onSuccess(Response<String> response) {                                    Log.i(TAG, "onSuccess: "+response.body());                                    try {                                        JSONObject mJsonObject=new JSONObject(response.body());                                        int stutus = mJsonObject.optInt("status");                                        if(stutus==1){                                            iv_user_essay_draft.setSelected(false);                                            mEssayMessageLists.clear();                                            initNetData(0, false, false);                                        }else {                                            CommonUtil.getCommonUtil().toast(mJsonObject.optString("err_msg"));                                        }                                    }                                    catch (JSONException e) {                                        e.printStackTrace();                                    }                                }                            });                }            }        });        //发布        tv_user_essay_draft_2.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View v) {                showReleasePop();            }        });        //刷新数据        srl_user_essay_draft.setOnRefreshListener(new SwipeRefreshLayout.OnRefreshListener() {            @Override            public void onRefresh() {                page = 0;                initNetData(page, false, true);            }        });        //加载        mEssayDraftAdapter.setOnLoadMoreListener(new BaseQuickAdapter.RequestLoadMoreListener() {            @Override            public void onLoadMoreRequested() {                page++;                initNetData(page, true, false);            }        }, rv_user_essay_draft);        //选择        mEssayDraftAdapter.setOnSelectListener(new EssayDraftAdapter.OnSelectListener() {            @Override            public void onSelect(boolean status) {                iv_user_essay_draft.setSelected(status);            }        });        //上线        mEssayDraftAdapter.setOnReleaseListener(new EssayDraftAdapter.OnReleaseListener() {            @Override            public void onRelease(String essayID) {                ReleaseUtil.getReleaseUtil().actionEssagStatus(EssayDraftActivity.this,userId,userKey,essayID,"2");                ReleaseUtil.getReleaseUtil().setOnEssaySelectListener(new ReleaseUtil.OnEssaySelectListener() {                    @Override                    public void onEssaySelect() {                        iv_user_essay_draft.setSelected(false);                        mEssayMessageLists.clear();                        initNetData(0, false, false);                        setResult(501);                    }                });            }        });    }    private int page = 0;    /**     * 弹出发布选择框     */    private void showReleasePop() {        View view = LayoutInflater.from(mContext).inflate(R.layout.item_show_user_essay_message, null);        //发布文章        LinearLayout ll_show_user_release_essay = CommonUtil.getCommonUtil().bindView(view, R.id.ll_show_user_release_essay);        //发布视频        LinearLayout ll_show_user_release_video = CommonUtil.getCommonUtil().bindView(view, R.id.ll_show_user_release_video);        mPopupWindow = CommonUtil.getCommonUtil().showPopWindowIsButtom(mContext, view, tv_user_essay_draft_1, getWindow());        //发布文章        ll_show_user_release_essay.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View v) {                if (mPopupWindow != null && mPopupWindow.isShowing()) {                    mPopupWindow.dismiss();                }                Intent mIntent = new Intent();                mIntent.setClass(mContext, ReleaseActivity.class);                mIntent.putExtra("Release", RELEASE_ESSAY);                startActivityForResult(mIntent, 400);            }        });        //发布视频        ll_show_user_release_video.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View v) {                if (mPopupWindow != null && mPopupWindow.isShowing()) {                    mPopupWindow.dismiss();                }                Intent mIntent = new Intent();                mIntent.setClass(mContext, ReleaseActivity.class);                mIntent.putExtra("Release", RELEASE_VIDEO);                startActivity(mIntent);            }        });    }    /**     * 初始化网络数据     *     * @param page     * @param isLoad     * @param isRefresh     */    private void initNetData(int page, final boolean isLoad, final boolean isRefresh) {        OkGo.<String>post(ConfigUtil.REQUEST_ESSAT_LIST)                .params("user_id", userId)                .params("auth_key", userKey)                .params("status", "1")                .params("page", page + "")                .execute(new StringCallback() {                    @Override                    public void onStart(Request<String, ? extends Request> request) {                        super.onStart(request);                        if (!isLoad && !isRefresh) {                            dialog = CommonUtil.getCommonUtil().ejectLaoding(mContext, "正在加载");                        }                    }                    @Override                    public void onError(Response<String> response) {                        super.onError(response);                        CommonUtil.getCommonUtil().toast(ConfigUtil.HINT_OVERTIME);                    }                    @Override                    public void onFinish() {                        super.onFinish();                        if (!isLoad && !isRefresh) {                            if (dialog != null && dialog.isShowing()) {                                dialog.dismiss();                                dialog = null;                            }                        }                        if (srl_user_essay_draft.isRefreshing()) {                            srl_user_essay_draft.setRefreshing(false);                        }                    }                    @Override                    public void onSuccess(Response<String> response) {                        try {                            com.mzth.createcause.entity.user.EssayMessageEntity mEssayMessageEntity = new com.mzth.createcause.entity.user.EssayMessageEntity(new JSONObject(response.body()));                            if (mEssayMessageEntity.getStatus() == 1) {                                if (isRefresh) {                                    mEssayMessageLists.clear();                                }                                mEssayMessageLists.addAll(mEssayMessageEntity.getmEssayMessageLists());                                mEssayDraftAdapter.notifyDataSetChanged();                                if (mEssayMessageEntity.getPage() + 1 < mEssayMessageEntity.getPage_total()) {                                    mEssayDraftAdapter.loadMoreComplete();                                } else {                                    mEssayDraftAdapter.loadMoreEnd();                                }                            } else {                                CommonUtil.getCommonUtil().toast(mEssayMessageEntity.getErr_mag());                            }                        } catch (JSONException e) {                            e.printStackTrace();                        }                    }                });    }    @Override    protected void onActivityResult(int requestCode, int resultCode, Intent data) {        super.onActivityResult(requestCode, resultCode, data);        if (requestCode == 400) {            if (resultCode == 403) {                mEssayMessageLists.clear();                initNetData(0, false, false);            }        }    }}